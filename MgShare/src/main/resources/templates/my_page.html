<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>マイページ - MG_Share</title>
  <!-- Bootstrap Core CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="styles.css" rel="stylesheet" />
</head>
<body>
<!-- Navigation bar with content -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="/user/main">MG Share</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="/user/main">メインページ</a></li>
        <li class="nav-item"><a class="nav-link small text-muted" href="/user/logout">ログアウト</a></li>
      </ul>
    </div>
  </div>
</nav>
<!-- My Page Content -->
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-lg border-5 rounded-lg mt-5">
        <div class="card-header"><h3 class="text-center font-weight-light my-4">マイページ</h3></div>
        <div class="card-body">
          <h4 class="mb-3">会員情報</h4>
          <p>氏名: <span th:text="${user.username}">田中 太郎</span></p>
          <p>メール: <span th:text="${user.userEmail}">tanaka@example.com</span></p>
          <p>電話番号: <span th:text="${user.phoneNumber}">080-2222-3333</span></p>
          <div class="mb-3">
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#updateModal">情報を更新</button>
            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">会員脱退</button>
          </div>
          <h4 class="mt-5 mb-3">貸出履歴</h4>
          <ul class="list-group" id="loanHistory">
            <!-- JavaScript로 대출 목록을 동적으로 추가 -->
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Update Modal -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateModalLabel">情報を更新</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updateForm" action="/user/update">
          <div class="mb-3">
            <label for="updateName" class="form-label">氏名</label>
            <input type="text" class="form-control" id="updateName" name="username" required>
          </div>
          <div class="mb-3">
            <label for="updateEmail" class="form-label" > メール</label>
            <input type="email" class="form-control" id="updateEmail" name="userEmail" autocomplete="username" required>
          </div>
          <div class="mb-3">
            <label for="updatePhoneNumber" class="form-label">電話番号</label>
            <input type="tel" class="form-control" id="updatePhoneNumber" name="phoneNumber" required>
          </div>
          <div class="mb-3">
            <label for="updatePassword" class="form-label">Password</label>
            <input type="password" class="form-control" id="updatePassword" name="password">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
        <button type="button" class="btn btn-primary" onclick="updateUserInfo()">保存</button>
      </div>
    </div>
  </div>
</div>
<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">会員脱退</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        本当に会員脱退しますか？
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
        <button type="button" class="btn btn-danger" onclick="deleteUser()">脱退</button>
      </div>
    </div>
  </div>
</div>
<!-- Bootstrap core JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Core theme JS-->
<script src="js/scripts.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    loadLoanHistory();
  });

  function loadLoanHistory() {
    // 나중에 서버에서 데이터를 가져와서 사용할 수 있도록 설정
    // 현재는 예제 데이터로 대체
    const loanData = [
      { itemName: "書籍「ビジネスの基礎」", startDate: "2023.5.10", endDate: "2023.5.20" },
      { itemName: "書籍「マーケティング入門」", startDate: "2023.6.1", endDate: "2023.6.10" },
    ];

    const loanHistory = document.getElementById("loanHistory");
    loanHistory.innerHTML = ""; // 이전 데이터를 초기화

    loanData.forEach(loan => {
      const listItem = document.createElement("li");
      listItem.className = "list-group-item d-flex justify-content-between align-items-center";
      listItem.innerHTML = `
        ${loan.itemName} - ${loan.startDate} ~ ${loan.endDate}
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="requestReturn(this)">返却申請</button>
      `;
      loanHistory.appendChild(listItem);
    });
  }

  function requestReturn(button) {
    // 반납 신청 로직을 구현
    // 예제에서는 버튼 텍스트 변경으로 대체
    button.textContent = "返却申請完了";
    button.classList.remove("btn-outline-secondary");
    button.classList.add("btn-success");
    button.disabled = true;

    // 신청 완료 메시지 표시
    alert("返却申請が完了しました。");
  }

  function updateUserInfo() {
    const form = document.getElementById('updateForm');
    const name = document.getElementById('updateName').value;
    const email = document.getElementById('updateEmail').value;
    const phoneNumber = document.getElementById('updatePhoneNumber').value;
    const password = document.getElementById('updatePassword').value;

    // 유효성 검사
    const validName = /^[a-zA-Z\u4E00-\u9FFF\u3040-\u30FF\uAC00-\uD7A3\s]+$/.test(name); // 영어, 한자, 히라가나, 가타카나, 한글
    const validPhoneNumber = /^[0-9]+$/.test(phoneNumber); // 오직 숫자만
    const validEmail = email.endsWith('@mirineglobal.com'); // 지정된 도메인

    if (!validName) {
      alert('名前には数字や特殊文字を含めることはできません。');
      return;
    }
    if (!validPhoneNumber) {
      alert('電話番号は数字のみを含めることができます。');
      return;
    }
    if (!validEmail) {
      alert('社内メールを入力してください。');
      return;
    }

    const formData = new FormData(form);

    fetch('/user/update', {
      method: 'POST',
      body: formData,
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('情報が更新されました。');
                // 모달 닫기
                const updateModalElement = document.getElementById('updateModal');
                const updateModal = bootstrap.Modal.getInstance(updateModalElement);
                updateModal.hide();

                // 페이지 새로고침
                window.location.reload();
              } else {
                alert('更新に失敗しました。');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('エラーが発生しました。');
            });
  }

  function deleteUser() {
    fetch('/user/delete', {
      method: 'POST',
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('会員脱退が完了しました。');
                // 페이지 새로고침 또는 로그아웃
                window.location.href = '/user/logout';
              } else {
                alert('脱退に失敗しました。');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('エラーが発生しました。');
            });
  }

</script>
</body>
</html>